# üñºÔ∏è Avatar Upload System - Context Document

## üìã T·ªïng quan h·ªá th·ªëng

### üéØ M·ª•c ƒë√≠ch
H·ªá th·ªëng upload v√† qu·∫£n l√Ω avatar cho ng∆∞·ªùi d√πng trong ·ª©ng d·ª•ng Event Management, ƒë·∫£m b·∫£o:
- Upload ·∫£nh t·ª´ m√°y t√≠nh
- L∆∞u tr·ªØ file avatar duy nh·∫•t cho m·ªói user
- Hi·ªÉn th·ªã avatar ƒë√∫ng c√°ch sau khi reload
- Kh√¥ng t√≠ch l≈©y file c≈©

### üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

```
Frontend (React)          Backend (ASP.NET Core)         Database (SQL Server)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ProfilePage.jsx ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ AuthController.cs       ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ User.Avatar     ‚îÇ
‚îÇ - File input    ‚îÇ      ‚îÇ - UploadAvatar()        ‚îÇ     ‚îÇ nvarchar(max)   ‚îÇ
‚îÇ - Preview       ‚îÇ      ‚îÇ - GetAvatar()           ‚îÇ     ‚îÇ                 ‚îÇ
‚îÇ - Submit        ‚îÇ      ‚îÇ - GetCurrentUserProfile ‚îÇ     ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                ‚îÇ
                                ‚ñº
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ File System     ‚îÇ
                        ‚îÇ wwwroot/uploads‚îÇ
                        ‚îÇ /avatars/      ‚îÇ
                        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß Backend Implementation

### üìÅ File Structure
```
src/
‚îú‚îÄ‚îÄ Controllers/
‚îÇ   ‚îî‚îÄ‚îÄ AuthController.cs          # Main controller
‚îú‚îÄ‚îÄ DTOs/
‚îÇ   ‚îî‚îÄ‚îÄ ProfileDTOs.cs             # Data transfer objects
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îî‚îÄ‚îÄ User.cs                    # User entity
‚îú‚îÄ‚îÄ Services/
‚îÇ   ‚îú‚îÄ‚îÄ AuthService.cs
‚îÇ   ‚îî‚îÄ‚îÄ IAuthService.cs
‚îú‚îÄ‚îÄ Repositories/
‚îÇ   ‚îú‚îÄ‚îÄ UserRepository.cs
‚îÇ   ‚îî‚îÄ‚îÄ IUserRepository.cs
‚îî‚îÄ‚îÄ wwwroot/
    ‚îî‚îÄ‚îÄ uploads/
        ‚îî‚îÄ‚îÄ avatars/               # Avatar storage
```

### üéÆ API Endpoints

#### 1. Upload Avatar
```http
POST /api/Auth/upload-avatar
Content-Type: multipart/form-data
Authorization: Bearer {token}

Body: FormData with 'avatar' file
```

**Response:**
```json
{
  "message": "Upload avatar th√†nh c√¥ng",
  "avatarUrl": "/uploads/avatars/user_1.jpg",
  "fileName": "user_1.jpg"
}
```

#### 2. Get Avatar
```http
GET /api/Auth/avatar/{fileName}
```

**Response:** Binary image data

#### 3. Get Profile
```http
GET /api/Auth/profile
Authorization: Bearer {token}
```

**Response:**
```json
{
  "userId": 1,
  "username": "user1",
  "fullName": "John Doe",
  "email": "john@example.com",
  "avatar": "/uploads/avatars/user_1.jpg",
  "phone": "0123456789",
  "role": "User",
  "createdAt": "2024-01-01T00:00:00Z",
  "updatedAt": "2024-01-01T00:00:00Z",
  "dateOfBirth": "1990-01-01T00:00:00Z",
  "gender": "Male"
}
```

### üíæ Database Schema

#### User Table
```sql
CREATE TABLE [User] (
    [UserID] int IDENTITY(1,1) PRIMARY KEY,
    [Username] nvarchar(50) NOT NULL,
    [FullName] nvarchar(100) NOT NULL,
    [Email] nvarchar(100) NOT NULL,
    [PasswordHash] nvarchar(255) NOT NULL,
    [Phone] nvarchar(20),
    [Role] nvarchar(20) NOT NULL,
    [Avatar] nvarchar(max),           -- Relative path to avatar
    [DateOfBirth] datetime2,
    [Gender] nvarchar(10),
    [CreatedAt] datetime2 NOT NULL,
    [UpdatedAt] datetime2 NOT NULL
);
```

### üîÑ Upload Process Flow

```mermaid
sequenceDiagram
    participant U as User
    participant F as Frontend
    participant B as Backend
    participant FS as File System
    participant DB as Database

    U->>F: Select image file
    F->>F: Generate preview
    U->>F: Click submit
    F->>B: POST /api/Auth/upload-avatar
    B->>B: Validate file (type, size)
    B->>FS: Delete old avatar files
    B->>FS: Save new file (user_{userId}.jpg)
    B->>DB: Update User.Avatar
    B->>F: Return success + avatarUrl
    F->>B: GET /api/Auth/avatar/{fileName}
    B->>F: Return image binary
    F->>U: Display updated avatar
```

## üé® Frontend Implementation

### üì± ProfilePage Component

#### File Input UI
```jsx
<div>
  <input
    type="file"
    accept="image/*"
    onChange={handleAvatarChange}
    style={{ display: 'none' }}
    id="avatar-upload"
  />
  <label
    htmlFor="avatar-upload"
    style={{
      display: 'flex',
      flexDirection: 'column',
      alignItems: 'center',
      padding: '20px',
      border: '2px dashed #ccc',
      borderRadius: '8px',
      cursor: 'pointer',
      backgroundColor: '#f9f9f9'
    }}
  >
    <div style={{ fontSize: '1.5rem' }}>üì∑</div>
    <div>Ch·ªçn ·∫£nh t·ª´ m√°y t√≠nh</div>
    <div style={{ fontSize: '0.75rem', color: '#9ca3af' }}>
      H·ªó tr·ª£: JPG, PNG, GIF (t·ªëi ƒëa 5MB)
    </div>
  </label>
</div>
```

#### Handle File Selection
```javascript
const handleAvatarChange = (e) => {
  const file = e.target.files[0];
  if (file) {
    // Validate file
    if (!file.type.startsWith('image/')) {
      alert('Vui l√≤ng ch·ªçn file ·∫£nh');
      return;
    }
    if (file.size > 5 * 1024 * 1024) {
      alert('File qu√° l·ªõn (t·ªëi ƒëa 5MB)');
      return;
    }
    
    setAvatarFile(file);
    
    // Generate preview
    const reader = new FileReader();
    reader.onload = (e) => {
      setAvatarPreview(e.target.result);
    };
    reader.readAsDataURL(file);
  }
};
```

#### Submit Handler
```javascript
const handleSubmit = async (e) => {
  e.preventDefault();
  
  try {
    let avatarUrl = profile.avatar; // Keep old avatar if no new upload
    
    // Upload new avatar if file selected
    if (avatarFile) {
      const uploadResult = await authAPI.uploadAvatar(avatarFile, token);
      avatarUrl = uploadResult.avatarUrl;
    }
    
    // Prepare update data
    const updateData = {
      fullName: formData.fullName,
      phone: formData.phone,
      dateOfBirth: formData.dateOfBirth,
      gender: formData.gender
    };
    
    // Only update avatar if new file was uploaded
    if (avatarFile && avatarUrl !== profile.avatar) {
      updateData.avatar = avatarUrl;
    }
    
    // Update profile
    await authAPI.updateProfile(updateData, token);
    
    // Refresh profile data
    const updatedProfile = await authAPI.getCurrentUserProfile(token);
    setProfile(updatedProfile);
    
    alert('C·∫≠p nh·∫≠t profile th√†nh c√¥ng!');
  } catch (error) {
    console.error('Error updating profile:', error);
    alert('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t profile');
  }
};
```

### üåê API Service

#### Upload Avatar
```javascript
export const uploadAvatar = async (file, token) => {
  const formData = new FormData();
  formData.append('avatar', file);
  
  const response = await fetch(`${API_BASE_URL}/Auth/upload-avatar`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    },
    body: formData
  });
  
  if (!response.ok) {
    throw new Error('Upload failed');
  }
  
  return await response.json();
};
```

#### Get Current User Profile
```javascript
export const getCurrentUserProfile = async (token) => {
  const response = await fetch(`${API_BASE_URL}/Auth/profile`, {
    headers: {
      'Authorization': `Bearer ${token}`,
      'Content-Type': 'application/json'
    }
  });
  
  if (!response.ok) {
    throw new Error('Failed to get profile');
  }
  
  const profile = await response.json();
  
  // Convert relative avatar URL to absolute URL
  if (profile.avatar && profile.avatar.startsWith('/')) {
    const fileName = profile.avatar.split('/').pop();
    profile.avatar = `${API_BASE_URL}/Auth/avatar/${fileName}`;
  }
  
  return profile;
};
```

## üîß Backend Core Logic

### üì§ Upload Avatar Method

```csharp
[HttpPost("upload-avatar")]
[Authorize]
public async Task<IActionResult> UploadAvatar(IFormFile avatar)
{
    try
    {
        // Validate file
        if (avatar == null || avatar.Length == 0)
            return BadRequest(new { message = "Kh√¥ng c√≥ file ƒë∆∞·ª£c ch·ªçn" });

        if (!avatar.ContentType.StartsWith("image/"))
            return BadRequest(new { message = "File ph·∫£i l√† ·∫£nh" });

        if (avatar.Length > 5 * 1024 * 1024) // 5MB
            return BadRequest(new { message = "File qu√° l·ªõn (t·ªëi ƒëa 5MB)" });

        var userId = GetUserIdFromToken();
        if (userId == null)
            return Unauthorized(new { message = "Token kh√¥ng h·ª£p l·ªá" });

        // Create uploads directory if not exists
        var uploadsFolder = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "avatars");
        if (!Directory.Exists(uploadsFolder))
            Directory.CreateDirectory(uploadsFolder);

        // Delete old avatar files FIRST
        var oldFiles = Directory.GetFiles(uploadsFolder, $"user_{userId}.*");
        foreach (var oldFile in oldFiles)
        {
            try
            {
                System.IO.File.Delete(oldFile);
                Console.WriteLine($"ƒê√£ x√≥a file c≈©: {oldFile}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Kh√¥ng th·ªÉ x√≥a file c≈© {oldFile}: {ex.Message}");
            }
        }

        // Create fixed filename
        var fileExtension = Path.GetExtension(avatar.FileName);
        var fileName = $"user_{userId}{fileExtension}";
        var filePath = Path.Combine(uploadsFolder, fileName);

        // Save new file AFTER deleting old ones
        using (var stream = new FileStream(filePath, FileMode.Create))
        {
            await avatar.CopyToAsync(stream);
        }

        // Update database
        var avatarUrl = $"/uploads/avatars/{fileName}";
        var user = await _userRepository.GetUserByIdAsync(userId.Value);
        if (user != null)
        {
            user.Avatar = avatarUrl;
            user.UpdatedAt = DateTime.UtcNow;
            await _userRepository.UpdateUserAsync(user);
        }

        return Ok(new { 
            message = "Upload avatar th√†nh c√¥ng", 
            avatarUrl = avatarUrl,
            fileName = fileName
        });
    }
    catch (Exception ex)
    {
        return BadRequest(new { message = "C√≥ l·ªói x·∫£y ra", error = ex.Message });
    }
}
```

### üñºÔ∏è Get Avatar Method

```csharp
[HttpGet("avatar/{fileName}")]
public IActionResult GetAvatar(string fileName)
{
    try
    {
        var filePath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot", "uploads", "avatars", fileName);

        if (!System.IO.File.Exists(filePath))
            return NotFound(new { message = "Avatar not found" });

        var fileBytes = System.IO.File.ReadAllBytes(filePath);
        var contentType = GetContentType(fileName);

        return File(fileBytes, contentType);
    }
    catch (Exception ex)
    {
        return BadRequest(new { message = "Error serving avatar", error = ex.Message });
    }
}

private string GetContentType(string fileName)
{
    var extension = Path.GetExtension(fileName).ToLowerInvariant();
    return extension switch
    {
        ".jpg" or ".jpeg" => "image/jpeg",
        ".png" => "image/png",
        ".gif" => "image/gif",
        ".webp" => "image/webp",
        _ => "application/octet-stream"
    };
}
```

## üõ†Ô∏è Configuration

### üìÅ Static Files (Program.cs)

```csharp
// Configure static files
app.UseStaticFiles();

// Configure CORS
app.UseCors(AppConstants.CORS_POLICY_NAME);

// Configure routing
app.MapControllers();
```

### üîí Authentication

```csharp
// JWT Authentication
builder.Services.AddAuthentication(JwtBearerDefaults.AuthenticationScheme)
    .AddJwtBearer(options =>
    {
        options.TokenValidationParameters = new TokenValidationParameters
        {
            ValidateIssuer = true,
            ValidateAudience = true,
            ValidateLifetime = true,
            ValidateIssuerSigningKey = true,
            ValidIssuer = builder.Configuration["Jwt:Issuer"],
            ValidAudience = builder.Configuration["Jwt:Audience"],
            IssuerSigningKey = new SymmetricSecurityKey(
                Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"]))
        };
    });
```

## üêõ Troubleshooting

### ‚ùå Common Issues

#### 1. Avatar kh√¥ng hi·ªÉn th·ªã sau reload
**Nguy√™n nh√¢n:** Static files kh√¥ng ƒë∆∞·ª£c serve ƒë√∫ng c√°ch
**Gi·∫£i ph√°p:** 
- Ki·ªÉm tra `app.UseStaticFiles()` trong Program.cs
- S·ª≠ d·ª•ng API endpoint `/api/Auth/avatar/{fileName}` thay v√¨ static files

#### 2. Nhi·ªÅu file avatar ƒë∆∞·ª£c t·∫°o
**Nguy√™n nh√¢n:** Kh√¥ng x√≥a file c≈© tr∆∞·ªõc khi l∆∞u file m·ªõi
**Gi·∫£i ph√°p:** 
- X√≥a file c≈© tr∆∞·ªõc: `Directory.GetFiles(uploadsFolder, $"user_{userId}.*")`
- S·ª≠ d·ª•ng t√™n file c·ªë ƒë·ªãnh: `user_{userId}.jpg`

#### 3. File kh√¥ng ƒë∆∞·ª£c l∆∞u
**Nguy√™n nh√¢n:** Th∆∞ m·ª•c kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng c√≥ quy·ªÅn ghi
**Gi·∫£i ph√°p:**
```csharp
if (!Directory.Exists(uploadsFolder))
    Directory.CreateDirectory(uploadsFolder);
```

### üîç Debug Logs

```csharp
// Add logging for debugging
Console.WriteLine($"T√¨m file c≈©: {oldFile}");
Console.WriteLine($"File c≈© c√≥ t·ªìn t·∫°i: {System.IO.File.Exists(oldFile)}");
Console.WriteLine($"ƒê√£ x√≥a file c≈©: {oldFile}");
```

## üìä File Naming Convention

### üè∑Ô∏è Avatar Files
```
uploads/avatars/
‚îú‚îÄ‚îÄ user_1.jpg      # User ID 1
‚îú‚îÄ‚îÄ user_2.png     # User ID 2  
‚îú‚îÄ‚îÄ user_3.gif     # User ID 3
‚îî‚îÄ‚îÄ user_4.webp    # User ID 4
```

### üìù Database Storage
```sql
-- User.Avatar field stores relative path
UPDATE [User] SET [Avatar] = '/uploads/avatars/user_1.jpg' WHERE [UserID] = 1;
```

## üöÄ Performance Considerations

### üíæ File Size Limits
- Maximum file size: 5MB
- Supported formats: JPG, PNG, GIF, WebP
- Image compression: Consider adding image optimization

### üîÑ Caching
- Browser caching for avatar images
- Consider CDN for production
- Cache busting with timestamps (if needed)

### üóÇÔ∏è File Cleanup
- Automatic cleanup of orphaned files
- Regular maintenance of uploads folder
- Backup strategy for user avatars

## üìã Testing Checklist

### ‚úÖ Upload Functionality
- [ ] File validation (type, size)
- [ ] Preview generation
- [ ] Upload success response
- [ ] Database update
- [ ] File system storage

### ‚úÖ Display Functionality  
- [ ] Avatar shows after upload
- [ ] Avatar persists after page reload
- [ ] Avatar updates when changed
- [ ] No duplicate files created

### ‚úÖ Error Handling
- [ ] Invalid file type rejection
- [ ] File size limit enforcement
- [ ] Network error handling
- [ ] Authentication error handling

## üîß Development Commands

### üèÉ‚Äç‚ôÇÔ∏è Run Backend
```bash
cd src
dotnet run
```

### üèÉ‚Äç‚ôÇÔ∏è Run Frontend
```bash
cd ../TheGrind5_EventManagement_Frontend
npm start
```

### üßπ Clean Uploads
```bash
# Remove all avatar files
rm -rf src/wwwroot/uploads/avatars/*
```

## üìö Related Files

### Backend Files
- `src/Controllers/AuthController.cs` - Main controller
- `src/DTOs/ProfileDTOs.cs` - Data transfer objects
- `src/Models/User.cs` - User entity
- `src/Program.cs` - Application configuration

### Frontend Files
- `src/pages/ProfilePage.jsx` - Profile page component
- `src/services/api.js` - API service functions
- `src/contexts/AuthContext.js` - Authentication context

### Database Files
- `src/Migrations/` - Entity Framework migrations
- `AddUserProfileFields.sql` - Database schema updates

---

**üìÖ Last Updated:** January 2024  
**üë®‚Äçüíª Maintainer:** Development Team  
**üîó Related Issues:** Avatar upload, File management, User profile

