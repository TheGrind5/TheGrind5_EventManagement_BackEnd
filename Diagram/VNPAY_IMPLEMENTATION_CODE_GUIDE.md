# H∆∞·ªõng D·∫´n Code Chi Ti·∫øt - VNPay Webhook Implementation

> T√†i li·ªáu n√†y cung c·∫•p code m·∫´u chi ti·∫øt ƒë·ªÉ AI c√≥ th·ªÉ implement tr·ª±c ti·∫øp, kh√¥ng c·∫ßn suy nghƒ© nhi·ªÅu.

## üéØ M·ª•c Ti√™u
Cung c·∫•p code templates ho√†n ch·ªânh cho t·∫•t c·∫£ c√°c components c·∫ßn thi·∫øt ƒë·ªÉ implement VNPay Webhook.

---

## üì¶ B∆∞·ªõc 1: Install Packages

```bash
cd src
dotnet add package QRCoder
```

---

## üì¶ B∆∞·ªõc 2: Database Migration

### 2.1. Update Payment Model

**File**: `src/Models/Payment.cs`

```csharp
// <auto-generated> This file has been auto generated by EF Core Power Tools. </auto-generated>
#nullable disable
using System;
using System.Collections.Generic;
using System.ComponentModel.DataAnnotations;

namespace TheGrind5_EventManagement.Models;

public partial class Payment
{
    public int PaymentId { get; set; }

    public int OrderId { get; set; }

    [Range(0, double.MaxValue, ErrorMessage = "Amount must be non-negative")]
    public decimal Amount { get; set; }

    [Required]
    public string Method { get; set; }

    [RegularExpression("^(Initiated|Succeeded|Failed|Refunded)$", ErrorMessage = "Status must be Initiated, Succeeded, Failed, or Refunded")]
    public string Status { get; set; }

    public DateTime PaymentDate { get; set; }

    // VNPay specific fields
    public string? TransactionId { get; set; }
    public string? VnpTxnRef { get; set; }
    public string? ResponseCode { get; set; }
    public string? TransactionStatus { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? UpdatedAt { get; set; }

    public virtual Order Order { get; set; }
}
```

### 2.2. Create Migration

```bash
dotnet ef migrations add AddVNPayFieldsToPayment
dotnet ef database update
```

---

## üì¶ B∆∞·ªõc 3: VNPay Constants

**File**: `src/Constants/VNPayConstants.cs` (T·∫†O M·ªöI)

```csharp
namespace TheGrind5_EventManagement.Constants;

public static class VNPayConstants
{
    public const string VERSION = "2.1.0";
    public const string COMMAND = "pay";
    public const string CURRENCY = "VND";
    public const string LOCALE = "vn";
    public const string ORDER_TYPE = "other";
    public const string TIMEZONE = "SE Asia Standard Time";

    // Response Codes
    public const string RESPONSE_SUCCESS = "00";
    public const string RESPONSE_SUSPECT = "07";
    public const string RESPONSE_NOT_REGISTERED = "09";
    public const string RESPONSE_AUTH_FAILED = "10";
    public const string RESPONSE_EXPIRED = "11";
    public const string RESPONSE_BLOCKED = "12";
    public const string RESPONSE_INVALID_OTP = "13";
    public const string RESPONSE_USER_CANCELLED = "24";
    public const string RESPONSE_INSUFFICIENT = "51";
    public const string RESPONSE_EXCEED_LIMIT = "65";
    public const string RESPONSE_BANK_MAINTENANCE = "75";
    public const string RESPONSE_INVALID_PIN = "79";
    public const string RESPONSE_UNKNOWN_ERROR = "99";

    // Transaction Status
    public const string TXN_STATUS_SUCCESS = "00";
    public const string TXN_STATUS_INCOMPLETE = "01";
    public const string TXN_STATUS_ERROR = "02";
    public const string TXN_STATUS_REVERSED = "04";
    public const string TXN_STATUS_REFUND_PROCESSING = "05";
    public const string TXN_STATUS_REFUND_SENT = "06";
    public const string TXN_STATUS_FRAUD_SUSPECTED = "07";
    public const string TXN_STATUS_REFUND_REJECTED = "09";

    // Payment Status Mapping
    public const string STATUS_INITIATED = "Initiated";
    public const string STATUS_SUCCEEDED = "Succeeded";
    public const string STATUS_FAILED = "Failed";
    public const string STATUS_REFUNDED = "Refunded";
}
```

---

## üì¶ B∆∞·ªõc 4: DTOs

**File**: `src/DTOs/PaymentDTOs.cs` (T·∫†O M·ªöI)

```csharp
using TheGrind5_EventManagement.Constants;

namespace TheGrind5_EventManagement.DTOs;

// Request ƒë·ªÉ t·∫°o VNPay payment
public record CreateVNPayPaymentRequest
{
    public int OrderId { get; init; }
    public string? ReturnUrl { get; init; }
}

// Response sau khi t·∫°o payment
public record CreateVNPayPaymentResponse
{
    public int PaymentId { get; init; }
    public string PaymentUrl { get; init; }
    public string QrCodeUrl { get; init; }
    public DateTime ExpiredAt { get; init; }
}

// Webhook data t·ª´ VNPay
public record VNPayWebhookData
{
    public string vnp_TmnCode { get; init; } = string.Empty;
    public long vnp_Amount { get; init; }
    public string vnp_BankCode { get; init; } = string.Empty;
    public string? vnp_BankTranNo { get; init; }
    public string? vnp_CardType { get; init; }
    public string vnp_PayDate { get; init; } = string.Empty;
    public string vnp_OrderInfo { get; init; } = string.Empty;
    public string vnp_TransactionNo { get; init; } = string.Empty;
    public string vnp_ResponseCode { get; init; } = string.Empty;
    public string vnp_TransactionStatus { get; init; } = string.Empty;
    public string vnp_TxnRef { get; init; } = string.Empty;
    public string vnp_SecureHash { get; init; } = string.Empty;
    public string? vnp_SecureHashType { get; init; }
    public string? vnp_CreateDate { get; init; }
    public string? vnp_IpAddr { get; init; }
    public string? vnp_CurrCode { get; init; }
}

// Payment status response
public record PaymentStatusResponse
{
    public int PaymentId { get; init; }
    public string Status { get; init; } = string.Empty;
    public string? TransactionId { get; init; }
}

// Configuration binding model
public class VNPaySettings
{
    public string TmnCode { get; set; } = string.Empty;
    public string HashSecret { get; set; } = string.Empty;
    public string PaymentUrl { get; set; } = string.Empty;
    public string ReturnUrl { get; set; } = string.Empty;
    public string IpnUrl { get; set; } = string.Empty;
    public string QueryUrl { get; set; } = string.Empty;
    public string Command { get; set; } = VNPayConstants.COMMAND;
    public string CurrCode { get; set; } = VNPayConstants.CURRENCY;
    public string Version { get; set; } = VNPayConstants.VERSION;
    public string Locale { get; set; } = VNPayConstants.LOCALE;
    public string TimeZoneId { get; set; } = VNPayConstants.TIMEZONE;
    public string OrderType { get; set; } = VNPayConstants.ORDER_TYPE;
}
```

---

## üì¶ B∆∞·ªõc 5: Update appsettings.json

**File**: `src/appsettings.json`

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Server=YOUR_SERVER;Database=YOUR_DATABASE;Trusted_Connection=true;TrustServerCertificate=true;MultipleActiveResultSets=true"
  },
  "Jwt": {
    "Key": "YOUR_SECRET_KEY_AT_LEAST_32_CHARACTERS_LONG_HERE",
    "Issuer": "TheGrind5_EventManagement",
    "Audience": "TheGrind5_EventManagement_Users"
  },
  "VNPay": {
    "TmnCode": "YOUR_TMN_CODE",
    "HashSecret": "YOUR_HASH_SECRET",
    "PaymentUrl": "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html",
    "ReturnUrl": "http://localhost:3000/payment/vnpay/return",
    "IpnUrl": "http://localhost:5000/api/Payment/vnpay/webhook",
    "QueryUrl": "https://sandbox.vnpayment.vn/merchant_webapi/api/transaction",
    "Command": "pay",
    "CurrCode": "VND",
    "Version": "2.1.0",
    "Locale": "vn",
    "TimeZoneId": "SE Asia Standard Time",
    "OrderType": "other"
  }
}
```

**File**: `src/appsettings.Example.json` (c·∫≠p nh·∫≠t)

```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "DefaultConnection": "Server=YOUR_SERVER;Database=YOUR_DATABASE;Trusted_Connection=true;TrustServerCertificate=true;MultipleActiveResultSets=true"
  },
  "Jwt": {
    "Key": "YOUR_SECRET_KEY_AT_LEAST_32_CHARACTERS_LONG_HERE",
    "Issuer": "TheGrind5_EventManagement",
    "Audience": "TheGrind5_EventManagement_Users"
  },
  "VNPay": {
    "TmnCode": "YOUR_TMN_CODE",
    "HashSecret": "YOUR_HASH_SECRET",
    "PaymentUrl": "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html",
    "ReturnUrl": "http://localhost:3000/payment/vnpay/return",
    "IpnUrl": "http://localhost:5000/api/Payment/vnpay/webhook",
    "QueryUrl": "https://sandbox.vnpayment.vn/merchant_webapi/api/transaction",
    "Command": "pay",
    "CurrCode": "VND",
    "Version": "2.1.0",
    "Locale": "vn",
    "TimeZoneId": "SE Asia Standard Time",
    "OrderType": "other"
  }
}
```

---

## üì¶ B∆∞·ªõc 6: VNPay Helper Service

**File**: `src/Helpers/VNPayHelper.cs` (T·∫†O M·ªöI)

```csharp
using System.Security.Cryptography;
using System.Text;
using TheGrind5_EventManagement.Constants;
using TheGrind5_EventManagement.DTOs;

namespace TheGrind5_EventManagement.Helpers;

public static class VNPayHelper
{
    /// <summary>
    /// T·∫°o HMAC SHA512 hash t·ª´ query string
    /// </summary>
    public static string CreateHash(string queryString, string secretKey)
    {
        var bytes = Encoding.UTF8.GetBytes(secretKey);
        var keyBytes = Encoding.UTF8.GetBytes(queryString);

        using (var hmac = new HMACSHA512(bytes))
        {
            var hash = hmac.ComputeHash(keyBytes);
            return BitConverter.ToString(hash).Replace("-", "").ToLower();
        }
    }

    /// <summary>
    /// S·∫Øp x·∫øp parameters theo alphabet v√† build query string
    /// </summary>
    public static string SortAndBuildQueryString(Dictionary<string, string> parameters)
    {
        var sortedParams = parameters
            .Where(kvp => !string.IsNullOrEmpty(kvp.Value))
            .OrderBy(kvp => kvp.Key)
            .Select(kvp => $"{kvp.Key}={Uri.EscapeDataString(kvp.Value)}");

        return string.Join("&", sortedParams);
    }

    /// <summary>
    /// T·∫°o query string t·ª´ VNPay parameters
    /// </summary>
    public static string BuildQueryString(Dictionary<string, string> parameters, string secretKey)
    {
        var sortedQuery = SortAndBuildQueryString(parameters);
        var hash = CreateHash(sortedQuery, secretKey);
        return sortedQuery + "&vnp_SecureHash=" + hash;
    }

    /// <summary>
    /// Validate VNPay signature
    /// </summary>
    public static bool ValidateSignature(VNPayWebhookData data, string secretKey)
    {
        var parameters = new Dictionary<string, string>();

        // Add all fields to dictionary
        if (!string.IsNullOrEmpty(data.vnp_TmnCode))
            parameters.Add("vnp_TmnCode", data.vnp_TmnCode);
        if (data.vnp_Amount > 0)
            parameters.Add("vnp_Amount", data.vnp_Amount.ToString());
        if (!string.IsNullOrEmpty(data.vnp_BankCode))
            parameters.Add("vnp_BankCode", data.vnp_BankCode);
        if (!string.IsNullOrEmpty(data.vnp_BankTranNo))
            parameters.Add("vnp_BankTranNo", data.vnp_BankTranNo);
        if (!string.IsNullOrEmpty(data.vnp_CardType))
            parameters.Add("vnp_CardType", data.vnp_CardType);
        if (!string.IsNullOrEmpty(data.vnp_PayDate))
            parameters.Add("vnp_PayDate", data.vnp_PayDate);
        if (!string.IsNullOrEmpty(data.vnp_OrderInfo))
            parameters.Add("vnp_OrderInfo", data.vnp_OrderInfo);
        if (!string.IsNullOrEmpty(data.vnp_TransactionNo))
            parameters.Add("vnp_TransactionNo", data.vnp_TransactionNo);
        if (!string.IsNullOrEmpty(data.vnp_ResponseCode))
            parameters.Add("vnp_ResponseCode", data.vnp_ResponseCode);
        if (!string.IsNullOrEmpty(data.vnp_TransactionStatus))
            parameters.Add("vnp_TransactionStatus", data.vnp_TransactionStatus);
        if (!string.IsNullOrEmpty(data.vnp_TxnRef))
            parameters.Add("vnp_TxnRef", data.vnp_TxnRef);
        if (!string.IsNullOrEmpty(data.vnp_CreateDate))
            parameters.Add("vnp_CreateDate", data.vnp_CreateDate);
        if (!string.IsNullOrEmpty(data.vnp_IpAddr))
            parameters.Add("vnp_IpAddr", data.vnp_IpAddr);
        if (!string.IsNullOrEmpty(data.vnp_CurrCode))
            parameters.Add("vnp_CurrCode", data.vnp_CurrCode);

        // Sort and build query string (excluding vnp_SecureHash and vnp_SecureHashType)
        var sortedQuery = SortAndBuildQueryString(parameters);
        
        // Create hash
        var calculatedHash = CreateHash(sortedQuery, secretKey);
        
        // Compare with received hash
        return calculatedHash.Equals(data.vnp_SecureHash, StringComparison.OrdinalIgnoreCase);
    }

    /// <summary>
    /// Convert amount to VNPay format (multiply by 100)
    /// </summary>
    public static long ConvertAmountToVnPayFormat(decimal amount)
    {
        return (long)(amount * 100);
    }

    /// <summary>
    /// Convert amount from VNPay format (divide by 100)
    /// </summary>
    public static decimal ConvertAmountFromVnPayFormat(long amount)
    {
        return amount / 100m;
    }

    /// <summary>
    /// Extract OrderId from TxnRef
    /// Format: ORDER_{OrderId}_{Timestamp}
    /// </summary>
    public static int? ExtractOrderIdFromTxnRef(string txnRef)
    {
        if (string.IsNullOrEmpty(txnRef) || !txnRef.StartsWith("ORDER_"))
            return null;

        var parts = txnRef.Split('_');
        if (parts.Length < 2)
            return null;

        if (int.TryParse(parts[1], out var orderId))
            return orderId;

        return null;
    }

    /// <summary>
    /// Get current VNPay date format (yyyyMMddHHmmss)
    /// </summary>
    public static string GetVnPayDateFormat()
    {
        return DateTime.UtcNow.AddHours(7).ToString("yyyyMMddHHmmss");
    }

    /// <summary>
    /// Generate TxnRef from OrderId
    /// </summary>
    public static string GenerateTxnRef(int orderId)
    {
        var timestamp = GetVnPayDateFormat();
        return $"ORDER_{orderId}_{timestamp}";
    }

    /// <summary>
    /// Check if transaction is success based on ResponseCode and TransactionStatus
    /// </summary>
    public static bool IsTransactionSuccess(string responseCode, string transactionStatus)
    {
        return responseCode == VNPayConstants.RESPONSE_SUCCESS && 
               transactionStatus == VNPayConstants.TXN_STATUS_SUCCESS;
    }
}
```

---

## üì¶ B∆∞·ªõc 7: Payment Repository

**File**: `src/Repositories/IPaymentRepository.cs` (T·∫†O M·ªöI)

```csharp
using TheGrind5_EventManagement.Models;

namespace TheGrind5_EventManagement.Repositories;

public interface IPaymentRepository
{
    Task<Payment?> GetPaymentByIdAsync(int paymentId);
    Task<Payment?> GetPaymentByOrderIdAsync(int orderId);
    Task<Payment?> GetPaymentByTransactionIdAsync(string transactionId);
    Task<Payment> CreatePaymentAsync(Payment payment);
    Task<bool> UpdatePaymentStatusAsync(int paymentId, string status, string? transactionId = null);
    Task<List<Payment>> GetPaymentsByOrderIdAsync(int orderId);
}
```

**File**: `src/Repositories/PaymentRepository.cs` (T·∫†O M·ªöI)

```csharp
using Microsoft.EntityFrameworkCore;
using TheGrind5_EventManagement.Data;
using TheGrind5_EventManagement.Models;

namespace TheGrind5_EventManagement.Repositories;

public class PaymentRepository : IPaymentRepository
{
    private readonly EventDBContext _context;

    public PaymentRepository(EventDBContext context)
    {
        _context = context;
    }

    public async Task<Payment?> GetPaymentByIdAsync(int paymentId)
    {
        return await _context.Payments
            .Include(p => p.Order)
            .FirstOrDefaultAsync(p => p.PaymentId == paymentId);
    }

    public async Task<Payment?> GetPaymentByOrderIdAsync(int orderId)
    {
        return await _context.Payments
            .Include(p => p.Order)
            .Where(p => p.OrderId == orderId)
            .OrderByDescending(p => p.PaymentDate)
            .FirstOrDefaultAsync();
    }

    public async Task<Payment?> GetPaymentByTransactionIdAsync(string transactionId)
    {
        return await _context.Payments
            .Include(p => p.Order)
            .FirstOrDefaultAsync(p => p.TransactionId == transactionId);
    }

    public async Task<Payment> CreatePaymentAsync(Payment payment)
    {
        payment.CreatedAt = DateTime.UtcNow;
        _context.Payments.Add(payment);
        await _context.SaveChangesAsync();
        return payment;
    }

    public async Task<bool> UpdatePaymentStatusAsync(int paymentId, string status, string? transactionId = null)
    {
        var payment = await _context.Payments.FindAsync(paymentId);
        if (payment == null) return false;

        payment.Status = status;
        payment.UpdatedAt = DateTime.UtcNow;
        if (transactionId != null)
        {
            payment.TransactionId = transactionId;
        }

        await _context.SaveChangesAsync();
        return true;
    }

    public async Task<List<Payment>> GetPaymentsByOrderIdAsync(int orderId)
    {
        return await _context.Payments
            .Where(p => p.OrderId == orderId)
            .OrderByDescending(p => p.PaymentDate)
            .ToListAsync();
    }
}
```

---

## üì¶ B∆∞·ªõc 8: VNPay Service

**File**: `src/Business/IVNPayService.cs` (T·∫†O M·ªöI)

```csharp
using TheGrind5_EventManagement.DTOs;

namespace TheGrind5_EventManagement.Business;

public interface IVNPayService
{
    Task<CreateVNPayPaymentResponse> CreatePaymentAsync(int orderId, string returnUrl);
    Task<bool> ProcessWebhookAsync(VNPayWebhookData webhookData);
    Task<PaymentStatusResponse?> GetPaymentStatusAsync(int paymentId);
    Task<bool> CancelPaymentAsync(int paymentId);
    bool ValidateSignature(VNPayWebhookData webhookData);
}
```

**File**: `src/Services/VNPayService.cs` (T·∫†O M·ªöI)

```csharp
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using QRCoder;
using TheGrind5_EventManagement.Business;
using TheGrind5_EventManagement.Constants;
using TheGrind5_EventManagement.DTOs;
using TheGrind5_EventManagement.Helpers;
using TheGrind5_EventManagement.Models;
using TheGrind5_EventManagement.Repositories;

namespace TheGrind5_EventManagement.Services;

public class VNPayService : IVNPayService
{
    private readonly VNPaySettings _settings;
    private readonly IOrderService _orderService;
    private readonly IPaymentRepository _paymentRepository;
    private readonly ILogger<VNPayService> _logger;

    public VNPayService(
        IConfiguration configuration,
        IOrderService orderService,
        IPaymentRepository paymentRepository,
        ILogger<VNPayService> logger)
    {
        _settings = configuration.GetSection("VNPay").Get<VNPaySettings>() 
            ?? throw new InvalidOperationException("VNPay settings not found");
        _orderService = orderService;
        _paymentRepository = paymentRepository;
        _logger = logger;
    }

    public async Task<CreateVNPayPaymentResponse> CreatePaymentAsync(int orderId, string returnUrl)
    {
        _logger.LogInformation("Creating VNPay payment for order {OrderId}", orderId);

        // Get order
        var order = await _orderService.GetOrderModelByIdAsync(orderId);
        if (order == null)
            throw new ArgumentException($"Order {orderId} not found");

        if (order.Status != "Pending")
            throw new InvalidOperationException($"Order {orderId} is not in Pending status");

        // Generate TxnRef
        var txnRef = VNPayHelper.GenerateTxnRef(orderId);

        // Create payment record
        var payment = new Payment
        {
            OrderId = orderId,
            Amount = order.Amount - order.DiscountAmount,
            Method = "VNPay",
            Status = VNPayConstants.STATUS_INITIATED,
            PaymentDate = DateTime.UtcNow,
            VnpTxnRef = txnRef,
            CreatedAt = DateTime.UtcNow
        };

        await _paymentRepository.CreatePaymentAsync(payment);

        // Build payment URL
        var paymentUrl = CreatePaymentUrl(order, txnRef, returnUrl);

        // Generate QR code
        var qrCodeUrl = GenerateQrCode(paymentUrl);

        _logger.LogInformation("VNPay payment created: PaymentId={PaymentId}, TxnRef={TxnRef}", 
            payment.PaymentId, txnRef);

        return new CreateVNPayPaymentResponse
        {
            PaymentId = payment.PaymentId,
            PaymentUrl = paymentUrl,
            QrCodeUrl = qrCodeUrl,
            ExpiredAt = DateTime.UtcNow.AddMinutes(15) // VNPay default timeout
        };
    }

    public async Task<bool> ProcessWebhookAsync(VNPayWebhookData webhookData)
    {
        _logger.LogInformation("Processing VNPay webhook for TxnRef={TxnRef}", webhookData.vnp_TxnRef);

        try
        {
            // Validate signature first
            if (!ValidateSignature(webhookData))
            {
                _logger.LogWarning("Invalid signature for TxnRef={TxnRef}", webhookData.vnp_TxnRef);
                return false;
            }

            // Extract order ID
            var orderId = VNPayHelper.ExtractOrderIdFromTxnRef(webhookData.vnp_TxnRef);
            if (!orderId.HasValue)
            {
                _logger.LogError("Cannot extract OrderId from TxnRef={TxnRef}", webhookData.vnp_TxnRef);
                return false;
            }

            // Check if transaction already processed (idempotency)
            var existingPayment = await _paymentRepository.GetPaymentByTransactionIdAsync(webhookData.vnp_TransactionNo);
            if (existingPayment != null)
            {
                _logger.LogInformation("Transaction {TransactionId} already processed", webhookData.vnp_TransactionNo);
                return true;
            }

            // Get order
            var order = await _orderService.GetOrderModelByIdAsync(orderId.Value);
            if (order == null)
            {
                _logger.LogError("Order {OrderId} not found", orderId.Value);
                return false;
            }

            // Get payment
            var payment = await _paymentRepository.GetPaymentByOrderIdAsync(orderId.Value);
            if (payment == null)
            {
                _logger.LogError("Payment not found for Order {OrderId}", orderId.Value);
                return false;
            }

            // Update payment
            payment.TransactionId = webhookData.vnp_TransactionNo;
            payment.ResponseCode = webhookData.vnp_ResponseCode;
            payment.TransactionStatus = webhookData.vnp_TransactionStatus;
            payment.UpdatedAt = DateTime.UtcNow;

            // Check if success
            var isSuccess = VNPayHelper.IsTransactionSuccess(
                webhookData.vnp_ResponseCode, 
                webhookData.vnp_TransactionStatus);

            if (isSuccess)
            {
                payment.Status = VNPayConstants.STATUS_SUCCEEDED;
                
                // Update order status
                await _orderService.UpdateOrderStatusAsync(orderId.Value, "Paid");
                
                _logger.LogInformation("Payment succeeded for Order {OrderId}", orderId.Value);
            }
            else
            {
                payment.Status = VNPayConstants.STATUS_FAILED;
                
                // Update order status
                await _orderService.UpdateOrderStatusAsync(orderId.Value, "Failed");
                
                _logger.LogWarning("Payment failed for Order {OrderId}, ResponseCode={ResponseCode}", 
                    orderId.Value, webhookData.vnp_ResponseCode);
            }

            await _paymentRepository.UpdatePaymentStatusAsync(
                payment.PaymentId, 
                payment.Status, 
                payment.TransactionId);

            return true;
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error processing webhook for TxnRef={TxnRef}", webhookData.vnp_TxnRef);
            return false;
        }
    }

    public async Task<PaymentStatusResponse?> GetPaymentStatusAsync(int paymentId)
    {
        var payment = await _paymentRepository.GetPaymentByIdAsync(paymentId);
        if (payment == null)
            return null;

        return new PaymentStatusResponse
        {
            PaymentId = payment.PaymentId,
            Status = payment.Status,
            TransactionId = payment.TransactionId
        };
    }

    public async Task<bool> CancelPaymentAsync(int paymentId)
    {
        var payment = await _paymentRepository.GetPaymentByIdAsync(paymentId);
        if (payment == null)
            return false;

        return await _paymentRepository.UpdatePaymentStatusAsync(
            paymentId, 
            VNPayConstants.STATUS_FAILED, 
            null);
    }

    public bool ValidateSignature(VNPayWebhookData webhookData)
    {
        return VNPayHelper.ValidateSignature(webhookData, _settings.HashSecret);
    }

    #region Private Methods

    private string CreatePaymentUrl(Order order, string txnRef, string returnUrl)
    {
        var parameters = new Dictionary<string, string>
        {
            { "vnp_Version", _settings.Version },
            { "vnp_Command", _settings.Command },
            { "vnp_TmnCode", _settings.TmnCode },
            { "vnp_Amount", VNPayHelper.ConvertAmountToVnPayFormat(order.Amount - order.DiscountAmount).ToString() },
            { "vnp_CreateDate", VNPayHelper.GetVnPayDateFormat() },
            { "vnp_CurrCode", _settings.CurrCode },
            { "vnp_IpAddr", "127.0.0.1" }, // TODO: Get actual IP from HttpContext
            { "vnp_Locale", _settings.Locale },
            { "vnp_OrderInfo", $"Thanh toan don hang #{order.OrderId}" },
            { "vnp_OrderType", _settings.OrderType },
            { "vnp_ReturnUrl", returnUrl },
            { "vnp_TxnRef", txnRef }
        };

        var queryString = VNPayHelper.BuildQueryString(parameters, _settings.HashSecret);
        return $"{_settings.PaymentUrl}?{queryString}";
    }

    private string GenerateQrCode(string paymentUrl)
    {
        try
        {
            using var qrGenerator = new QRCodeGenerator();
            var qrCodeData = qrGenerator.CreateQrCode(paymentUrl, QRCodeGenerator.ECCLevel.Q);
            using var qrCode = new PngByteQRCode(qrCodeData);
            var qrCodeBytes = qrCode.GetGraphic(20);
            var base64String = Convert.ToBase64String(qrCodeBytes);
            return $"data:image/png;base64,{base64String}";
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error generating QR code");
            return string.Empty;
        }
    }

    #endregion
}
```

---

## üì¶ B∆∞·ªõc 9: Payment Controller

**File**: `src/Controllers/PaymentController.cs` (T·∫†O M·ªöI)

```csharp
using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using System.Security.Claims;
using TheGrind5_EventManagement.Business;
using TheGrind5_EventManagement.DTOs;
using TheGrind5_EventManagement.Services;

namespace TheGrind5_EventManagement.Controllers;

[Route("api/[controller]")]
[ApiController]
public class PaymentController : ControllerBase
{
    private readonly IVNPayService _vnPayService;
    private readonly IOrderService _orderService;
    private readonly ILogger<PaymentController> _logger;

    public PaymentController(
        IVNPayService vnPayService,
        IOrderService orderService,
        ILogger<PaymentController> logger)
    {
        _vnPayService = vnPayService;
        _orderService = orderService;
        _logger = logger;
    }

    [HttpPost("vnpay/create")]
    [Authorize]
    public async Task<IActionResult> CreateVNPayPayment([FromBody] CreateVNPayPaymentRequest request)
    {
        try
        {
            var userId = GetUserIdFromToken();
            if (userId == null)
                return Unauthorized(new { message = "Token kh√¥ng h·ª£p l·ªá" });

            // Validate order ownership
            var order = await _orderService.GetOrderByIdAsync(request.OrderId);
            if (order == null)
                return NotFound(new { message = "Kh√¥ng t√¨m th·∫•y order" });

            if (order.CustomerId != userId.Value)
                return Forbid("B·∫°n ch·ªâ c√≥ th·ªÉ thanh to√°n order c·ªßa m√¨nh");

            if (order.Status != "Pending")
                return BadRequest(new { message = "Ch·ªâ c√≥ th·ªÉ thanh to√°n order ƒëang Pending" });

            // Create payment
            var response = await _vnPayService.CreatePaymentAsync(request.OrderId, request.ReturnUrl ?? "");

            return Ok(new { 
                message = "T·∫°o payment th√†nh c√¥ng", 
                payment = response 
            });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error creating VNPay payment");
            return BadRequest(new { message = "C√≥ l·ªói x·∫£y ra khi t·∫°o payment", error = ex.Message });
        }
    }

    [HttpPost("vnpay/webhook")]
    [HttpGet("vnpay/webhook")] // VNPay c√≥ th·ªÉ g·ªçi GET ho·∫∑c POST
    public async Task<IActionResult> VNPayWebhook()
    {
        try
        {
            _logger.LogInformation("VNPay webhook called");

            // Parse query parameters
            var webhookData = ParseWebhookData(Request);
            
            if (webhookData == null)
            {
                _logger.LogWarning("Failed to parse webhook data");
                return Ok("FAIL"); // VNPay expects plain text response
            }

            // Process webhook
            var success = await _vnPayService.ProcessWebhookAsync(webhookData);

            return Ok(success ? "SUCCESS" : "FAIL");
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error processing VNPay webhook");
            return Ok("FAIL");
        }
    }

    [HttpGet("{paymentId}/status")]
    [Authorize]
    public async Task<IActionResult> GetPaymentStatus(int paymentId)
    {
        try
        {
            var userId = GetUserIdFromToken();
            if (userId == null)
                return Unauthorized(new { message = "Token kh√¥ng h·ª£p l·ªá" });

            var status = await _vnPayService.GetPaymentStatusAsync(paymentId);
            if (status == null)
                return NotFound(new { message = "Kh√¥ng t√¨m th·∫•y payment" });

            // TODO: Validate user has access to this payment

            return Ok(status);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error getting payment status");
            return BadRequest(new { message = "C√≥ l·ªói x·∫£y ra", error = ex.Message });
        }
    }

    [HttpPost("{paymentId}/cancel")]
    [Authorize]
    public async Task<IActionResult> CancelPayment(int paymentId)
    {
        try
        {
            var userId = GetUserIdFromToken();
            if (userId == null)
                return Unauthorized(new { message = "Token kh√¥ng h·ª£p l·ªá" });

            var cancelled = await _vnPayService.CancelPaymentAsync(paymentId);
            if (!cancelled)
                return NotFound(new { message = "Kh√¥ng t√¨m th·∫•y payment" });

            return Ok(new { message = "H·ªßy payment th√†nh c√¥ng" });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error cancelling payment");
            return BadRequest(new { message = "C√≥ l·ªói x·∫£y ra", error = ex.Message });
        }
    }

    #region Helper Methods

    private VNPayWebhookData? ParseWebhookData(HttpRequest request)
    {
        try
        {
            return new VNPayWebhookData
            {
                vnp_TmnCode = request.Query["vnp_TmnCode"].ToString(),
                vnp_Amount = long.TryParse(request.Query["vnp_Amount"], out var amount) ? amount : 0,
                vnp_BankCode = request.Query["vnp_BankCode"].ToString(),
                vnp_BankTranNo = request.Query["vnp_BankTranNo"].ToString(),
                vnp_CardType = request.Query["vnp_CardType"].ToString(),
                vnp_PayDate = request.Query["vnp_PayDate"].ToString(),
                vnp_OrderInfo = request.Query["vnp_OrderInfo"].ToString(),
                vnp_TransactionNo = request.Query["vnp_TransactionNo"].ToString(),
                vnp_ResponseCode = request.Query["vnp_ResponseCode"].ToString(),
                vnp_TransactionStatus = request.Query["vnp_TransactionStatus"].ToString(),
                vnp_TxnRef = request.Query["vnp_TxnRef"].ToString(),
                vnp_SecureHash = request.Query["vnp_SecureHash"].ToString(),
                vnp_SecureHashType = request.Query["vnp_SecureHashType"].ToString(),
                vnp_CreateDate = request.Query["vnp_CreateDate"].ToString(),
                vnp_IpAddr = request.Query["vnp_IpAddr"].ToString(),
                vnp_CurrCode = request.Query["vnp_CurrCode"].ToString()
            };
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error parsing webhook data");
            return null;
        }
    }

    private int? GetUserIdFromToken()
    {
        var userIdClaim = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        return int.TryParse(userIdClaim, out int userId) ? userId : null;
    }

    #endregion
}
```

---

## üì¶ B∆∞·ªõc 10: Dependency Injection

**File**: `src/Extensions/ServiceCollectionExtensions.cs` (C·∫¨P NH·∫¨T)

```csharp
// ... existing code ...

public static IServiceCollection AddRepositories(this IServiceCollection services)
{
    services.AddScoped<IUserRepository, UserRepository>();
    services.AddScoped<IEventRepository, EventRepository>();
    services.AddScoped<IOrderRepository, OrderRepository>();
    services.AddScoped<IEventQuestionRepository, EventQuestionRepository>();
    services.AddScoped<IPaymentRepository, PaymentRepository>(); // ‚Üê Th√™m d√≤ng n√†y
    return services;
}

// ... existing code ...

public static IServiceCollection AddApplicationServices(this IServiceCollection services)
{
    services.AddScoped<IAuthService, AuthService>();
    services.AddScoped<IEventService, EventService>();
    services.AddScoped<IOrderService, OrderService>();
    services.AddScoped<IWalletService, WalletService>();
    services.AddScoped<IWishlistService, WishlistService>();
    services.AddScoped<ITicketService, TicketService>();
    services.AddScoped<IVoucherService, VoucherService>();
    services.AddScoped<ISampleDataExportService, SampleDataExportService>();
    services.AddScoped<INotificationService, NotificationService>();
    services.AddScoped<IEventQuestionService, EventQuestionService>();
    services.AddScoped<IAdminService, AdminService>();
    services.AddScoped<IVNPayService, VNPayService>(); // ‚Üê Th√™m d√≤ng n√†y
    return services;
}

// ... existing code ...
```

---

## üì¶ B∆∞·ªõc 11: Testing

### 11.1. Setup ngrok for local testing

```bash
# Download ngrok from https://ngrok.com/
# Run:
ngrok http 5000

# Copy the public URL (e.g., https://abc123.ngrok.io)
# Update appsettings.json:
# "IpnUrl": "https://abc123.ngrok.io/api/Payment/vnpay/webhook"
```

### 11.2. Test endpoints

```bash
# 1. Create payment
curl -X POST http://localhost:5000/api/Payment/vnpay/create \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -d '{"orderId": 1, "returnUrl": "http://localhost:3000/payment/vnpay/return"}'

# 2. Check webhook (manual test)
curl -X POST http://localhost:5000/api/Payment/vnpay/webhook \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d 'vnp_TmnCode=YOUR_TMN_CODE&vnp_Amount=1000000&...'

# 3. Get payment status
curl -X GET http://localhost:5000/api/Payment/1/status \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

---

## ‚úÖ Checklist Ho√†n Th√†nh

- [ ] Install QRCoder package
- [ ] Update Payment model
- [ ] Create migration v√† ch·∫°y `database update`
- [ ] T·∫°o VNPayConstants.cs
- [ ] T·∫°o PaymentDTOs.cs
- [ ] Update appsettings.json
- [ ] T·∫°o VNPayHelper.cs
- [ ] T·∫°o IPaymentRepository.cs v√† PaymentRepository.cs
- [ ] T·∫°o IVNPayService.cs v√† VNPayService.cs
- [ ] T·∫°o PaymentController.cs
- [ ] Update ServiceCollectionExtensions.cs
- [ ] Test v·ªõi VNPay Sandbox
- [ ] Setup monitoring v√† logging

---

**T√°c gi·∫£**: AI Assistant  
**Version**: 1.0  
**M·ª•c ƒë√≠ch**: Code templates s·∫µn s√†ng copy-paste ƒë·ªÉ implement nhanh ch√≥ng

